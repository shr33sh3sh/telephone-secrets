<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Directory</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: #f4f4f4; 
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #007bff;
        }
        h1 { color: #333; }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        #searchInput {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-edit { background: #007bff; color: white; padding: 5px 10px; font-size: 12px; }
        .btn-delete { background: #dc3545; color: white; padding: 5px 10px; font-size: 12px; }
        .btn-cancel { background: #6c757d; color: white; }
        .btn-save { background: #28a745; color: white; }
        .btn-logout { 
            background: #dc3545; 
            color: white;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #007bff;
            color: white;
            font-weight: bold;
        }
        tr:hover {
            background: #f5f5f5;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group textarea {
            resize: vertical;
            font-family: Arial, sans-serif;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .controls { flex-direction: column; }
            #searchInput { width: 100%; }
            table { font-size: 12px; }
            th, td { padding: 8px; }
        }
    </style>
</head>
<body>
    <button id="logoutBtn" class="btn-logout" onclick="logout()">Logout</button>
    
    <div class="container">
        <div class="header">
            <h1>üìû Phone Directory</h1>
            <div style="display: flex; gap: 10px;">
                <a href="/secrets" style="padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 4px;">üîê Secrets</a>
            </div>
        </div>
        
        <div class="controls">
            <input type="text" id="searchInput" placeholder="Search contacts by name, phone, or address...">
            <button class="btn-primary" onclick="addContact()">Add Contact</button>
            <button class="btn-success" onclick="exportContacts()">Export CSV</button>
        </div>
        
        <table id="contactsTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Address</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="4" class="loading">Loading contacts...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Edit/Add Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Edit Contact</h3>
            <div class="form-group">
                <label for="editName">Name: *</label>
                <input type="text" id="editName" required>
            </div>
            <div class="form-group">
                <label for="editPhone">Phone: *</label>
                <input type="tel" id="editPhone" required>
            </div>
            <div class="form-group">
                <label for="editAddress">Address:</label>
                <textarea id="editAddress" rows="3"></textarea>
            </div>
            <div class="modal-buttons">
                <button onclick="saveContact()" class="btn-save">Save</button>
                <button onclick="closeModal()" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
// Configuration
const API_BASE_URL = '/api/contacts';

// Global authenticated fetch wrapper
async function authFetch(url, options = {}) {
    const token = localStorage.getItem('token');
    
    if (!token) {
        console.error('No token found');
        redirectToLogin();
        return null;
    }

    const headers = {
        'Authorization': `Bearer ${token}`,
        ...(options.headers || {})
    };
    
    // Add Content-Type for JSON requests
    if (options.body && typeof options.body === 'string') {
        headers['Content-Type'] = 'application/json';
    }

    try {
        const response = await fetch(url, { 
            ...options, 
            headers
        });

        if (response.status === 401) {
            console.error('401 response received - token invalid or expired');
            redirectToLogin();
            return null;
        }

        if (response.status === 403) {
            alert('You do not have permission to perform this action.');
            return null;
        }

        return response;
    } catch (error) {
        console.error('Network error:', error);
        alert('Network error. Please check your connection.');
        return null;
    }
}

function redirectToLogin() {
    console.log('Redirecting to login page...');
    localStorage.removeItem('token');
    // Use replace to prevent back button issues
    window.location.replace('/');
}

// Debounce search
let searchTimeout;
function debounceSearch(search) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => loadContacts(search), 300);
}

// Load contacts
async function loadContacts(search = '') {
    try {
        const query = search ? `?search=${encodeURIComponent(search)}` : '';
        const response = await authFetch(`${API_BASE_URL}${query}`);

        if (!response) return;

        if (!response.ok) {
            const error = await response.json().catch(() => ({ error: 'Failed to load contacts' }));
            throw new Error(error.error || 'Error loading contacts');
        }

        const contacts = await response.json();
        const tbody = document.querySelector('#contactsTable tbody');
        tbody.innerHTML = '';

        if (!contacts || contacts.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align:center; padding: 20px; color: #666;">
                        ${search ? `No contacts found matching "${escapeHtml(search)}"` : 'No contacts found. Click "Add Contact" to get started!'}
                    </td>
                </tr>`;
            return;
        }

        contacts.forEach(contact => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${escapeHtml(contact.name)}</td>
                <td>${formatPhoneNumber(contact.phone)}</td>
                <td>${escapeHtml(contact.address || '-')}</td>
                <td>
                    <button onclick="editContact(${contact.id})" class="btn-edit">Edit</button>
                    <button onclick="deleteContact(${contact.id})" class="btn-delete">Delete</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch (error) {
        console.error('Error loading contacts:', error);
        alert(error.message || 'Failed to load contacts');
    }
}

// Store current edit contact
let currentEditContact = null;

// Add new contact
function addContact() {
    currentEditContact = { id: null };
    document.getElementById('modalTitle').textContent = 'Add New Contact';
    document.getElementById('editName').value = '';
    document.getElementById('editPhone').value = '';
    document.getElementById('editAddress').value = '';
    document.getElementById('editModal').style.display = 'block';
}

// Edit contact
async function editContact(id) {
    try {
        const response = await authFetch(`${API_BASE_URL}`);
        if (!response) return;
        
        const contacts = await response.json();
        const contact = contacts.find(c => c.id === id);
        
        if (!contact) {
            alert('Contact not found');
            return;
        }
        
        currentEditContact = contact;
        document.getElementById('modalTitle').textContent = 'Edit Contact';
        document.getElementById('editName').value = contact.name || '';
        document.getElementById('editPhone').value = contact.phone || '';
        document.getElementById('editAddress').value = contact.address || '';
        document.getElementById('editModal').style.display = 'block';
    } catch (error) {
        console.error('Error fetching contact:', error);
        alert('Failed to load contact details');
    }
}

function closeModal() {
    document.getElementById('editModal').style.display = 'none';
    currentEditContact = null;
}

// Save contact
async function saveContact() {
    const name = document.getElementById('editName').value.trim();
    const phone = document.getElementById('editPhone').value.trim();
    const address = document.getElementById('editAddress').value.trim();
    
    if (!name || !phone) {
        alert('Name and phone are required');
        return;
    }
    
    const isNew = !currentEditContact?.id;
    const url = isNew ? API_BASE_URL : `${API_BASE_URL}/${currentEditContact.id}`;
    const method = isNew ? 'POST' : 'PUT';
    
    try {
        const response = await authFetch(url, {
            method: method,
            body: JSON.stringify({ name, phone, address })
        });
        
        if (!response) return;
        
        if (response.ok) {
            alert(`Contact ${isNew ? 'added' : 'updated'} successfully!`);
            closeModal();
            loadContacts();
        } else {
            const data = await response.json();
            throw new Error(data.error || `Failed to ${isNew ? 'add' : 'update'} contact`);
        }
    } catch (error) {
        console.error('Error saving contact:', error);
        alert(error.message);
    }
}

// Delete contact
async function deleteContact(id) {
    if (!confirm('Are you sure you want to delete this contact? This action cannot be undone.')) return;
    
    try {
        const response = await authFetch(`${API_BASE_URL}/${id}`, {
            method: 'DELETE'
        });
        
        if (!response) return;
        
        if (response.ok) {
            alert('Contact deleted successfully!');
            loadContacts();
        } else {
            const data = await response.json();
            throw new Error(data.error || 'Failed to delete contact');
        }
    } catch (error) {
        console.error('Error deleting contact:', error);
        alert(error.message);
    }
}

// Export contacts
async function exportContacts() {
    try {
        const response = await authFetch(`${API_BASE_URL}/export`);
        
        if (!response) return;
        
        if (!response.ok) {
            throw new Error('Failed to export contacts');
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `contacts_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Error exporting contacts:', error);
        alert('Failed to export contacts');
    }
}

// Utility functions
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatPhoneNumber(phone) {
    if (!phone) return '';
    const cleaned = phone.replace(/\D/g, '');
    if (cleaned.length === 10) {
        return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
    }
    return phone;
}

// Logout
function logout() {
    if (confirm('Are you sure you want to log out?')) {
        localStorage.clear();
        sessionStorage.clear();
        window.location.replace('/');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    // Check authentication
    const token = localStorage.getItem('token');
    
    if (!token) {
        console.log('No token found, redirecting to login...');
        redirectToLogin();
        return;
    }
    
    console.log('Token found, loading contacts...');
    
    // Load contacts
    loadContacts();
    
    // Setup search
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchValue = e.target.value.trim();
            debounceSearch(searchValue);
        });
        
        // Also handle Enter key
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchValue = e.target.value.trim();
                clearTimeout(searchTimeout);
                loadContacts(searchValue);
            }
        });
    }
    
    // Close modal when clicking outside
    window.addEventListener('click', (event) => {
        const modal = document.getElementById('editModal');
        if (modal && event.target === modal) {
            closeModal();
        }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            closeModal();
        }
    });
});
    </script>
</body>
</html>